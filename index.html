<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四則計算モグラたたき対戦ゲーム</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, #FFB6C1, #FFC0CB);
            color: #4A4A4A;
            font-family: 'Varela Round', 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        
        #gameContainer {
            text-align: center;
            position: relative;
            max-width: 1340px;
            max-height: 740px;
            margin: 0 auto;
        }
        
        #gameArea {
            display: flex;
            gap: 20px;
            margin: 15px auto;
        }
        
        .player-area {
            width: 600px;
            height: 450px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1'/%3E%3C/svg%3E"), linear-gradient(180deg, #AEDFF7, #87CEEB);
            border: 8px solid #FFF;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .player-area::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, #8BC34A, transparent);
            border-radius: 0 0 12px 12px;
            z-index: 1;
        }
        
        .player1 {
            border-color: #66BB6A;
            box-shadow: 0 10px 25px rgba(102, 187, 106, 0.4);
        }
        
        .player2 {
            border-color: #FF7043;
            box-shadow: 0 10px 25px rgba(255, 112, 67, 0.4);
        }
        
        .player-name {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            font-weight: bold;
            background: #FFF;
            padding: 8px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .player1 .player-name {
            color: #2E7D32;
            border: 3px solid #66BB6A;
        }
        
        .player2 .player-name {
            color: #D84315;
            border: 3px solid #FF7043;
        }
        
        #gameInfo {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 20px 0;
            font-size: 20px;
            font-weight: bold;
            flex-wrap: wrap;
        }
        
        #gameInfo > div {
            background: #FFF;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: #4A4A4A;
        }
        
        #question {
            font-size: 36px;
            color: #4A4A4A;
            background: #FFF;
            padding: 15px 30px;
            border-radius: 30px;
            display: inline-block;
            margin: 15px 0;
            min-height: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            border: 3px solid #FFD54F;
        }
        
        #question::before, #question::after {
            content: "✨";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #FFD54F;
        }
        
        #question::before {
            left: 10px;
        }
        
        #question::after {
            right: 10px;
        }
        
        #controls {
            margin-top: 15px;
            color: #4A4A4A;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .mole-hole {
            position: absolute;
            width: 100px;
            height: 80px;
            background: radial-gradient(ellipse at center, #5D4037, #3E2723);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            border: 3px solid #795548;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            box-shadow: inset 0 -10px 15px rgba(0, 0, 0, 0.3);
        }
        
        .mole-hole::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            height: 15px;
            background: #8BC34A;
            border-radius: 50%;
            z-index: -1;
        }
        
        .mole {
            position: absolute;
            width: 80px;
            height: 65px;
            background: #B17F4A;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            top: 8px;
            left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
            border: 2px solid #8D6E63;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            animation: pop-up 0.5s ease-out;
            overflow: hidden;
        }
        
        .mole::before {
            content: "";
            position: absolute;
            top: -15px;
            width: 80px;
            height: 30px;
            background: #8D6E63;
            border-radius: 50%;
            z-index: -1;
        }
        
        .mole::after {
            content: "";
            position: absolute;
            top: 10px;
            width: 100%;
            height: 15px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
        
        .mole .eyes {
            position: absolute;
            top: 15px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 2;
        }
        
        .mole .eye {
            width: 12px;
            height: 12px;
            background: #000;
            border-radius: 50%;
            position: relative;
        }
        
        .mole .eye::after {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: #FFF;
            border-radius: 50%;
        }
        
        .mole .nose {
            position: absolute;
            top: 30px;
            width: 14px;
            height: 8px;
            background: #FF9E80;
            border-radius: 50%;
            z-index: 2;
        }
        
        .mole .answer {
            margin-top: 15px;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            color: #4A4A4A;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 18px;
        }
        
        .mole.hit {
            animation: hit 0.3s ease-out;
        }
        
        .mole.hit .eyes .eye {
            height: 2px;
            border-radius: 0;
            margin-top: 5px;
            transform: rotate(45deg);
        }
        
        .mole.hit .eyes .eye:last-child {
            transform: rotate(-45deg);
        }
        
        .mole.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        
        @keyframes pop-up {
            0% {
                transform: translateY(100%);
                opacity: 0;
            }
            60% {
                transform: translateY(-20%);
            }
            80% {
                transform: translateY(5%);
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes hit {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.8) rotate(5deg);
                background: #D7CCC8;
            }
            100% {
                transform: scale(1);
            }
        }
        
        .score-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            animation: score-pop 1s ease-out forwards;
            z-index: 100;
        }
        
        @keyframes score-pop {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 0;
            }
            20% {
                transform: scale(1.2) translateY(0);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(-50px);
                opacity: 0;
            }
        }
        
        .clouds {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: float-cloud linear infinite;
        }
        
        @keyframes float-cloud {
            0% {
                transform: translateX(-150px);
            }
            100% {
                transform: translateX(calc(100% + 150px));
            }
        }
        
        /* 設定パネル */
        #settingsPanel {
            background: #FFF;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: #F5F5F5;
            padding: 10px 15px;
            border-radius: 15px;
            min-width: 150px;
        }
        
        .setting-group h3 {
            margin: 0;
            font-size: 18px;
            color: #4A4A4A;
        }
        
        .setting-options {
            display: flex;
            gap: 8px;
        }
        
        .setting-option {
            padding: 5px 10px;
            background: #E0E0E0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .setting-option.selected {
            background: #FFD54F;
            color: #4A4A4A;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #startButton {
            background: #66BB6A;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(102, 187, 106, 0.4);
            margin-top: 10px;
        }
        
        #startButton:hover {
            background: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 187, 106, 0.5);
        }
        
        #startButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 187, 106, 0.4);
        }
        
        /* 勝利演出のスタイル */
        .winner-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFF;
            opacity: 0.8;
            animation: confetti-fall 4s linear forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .trophy {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            animation: trophy-appear 1s ease-out forwards;
        }
        
        @keyframes trophy-appear {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .winner-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #FFF;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 30px;
            border-radius: 30px;
            opacity: 0;
            animation: text-appear 1s ease-out 0.5s forwards;
        }
        
        @keyframes text-appear {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .star {
            position: absolute;
            background: #FFD700;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: star-spin 2s linear infinite;
        }
        
        @keyframes star-spin {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.2);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="settingsPanel">
            <div class="setting-group">
                <h3>計算の種類</h3>
                <div class="setting-options" id="operationOptions">
                    <div class="setting-option selected" data-value="all">全て</div>
                    <div class="setting-option" data-value="+">足し算</div>
                    <div class="setting-option" data-value="-">引き算</div>
                    <div class="setting-option" data-value="×">掛け算</div>
                    <div class="setting-option" data-value="÷">割り算</div>
                </div>
            </div>
            <div class="setting-group">
                <h3>難易度</h3>
                <div class="setting-options" id="difficultyOptions">
                    <div class="setting-option" data-value="easy">簡単</div>
                    <div class="setting-option selected" data-value="normal">普通</div>
                    <div class="setting-option" data-value="hard">難しい</div>
                </div>
            </div>
            <div class="setting-group">
                <h3>制限時間</h3>
                <div class="setting-options" id="timeOptions">
                    <div class="setting-option" data-value="30">30秒</div>
                    <div class="setting-option selected" data-value="60">60秒</div>
                    <div class="setting-option" data-value="90">90秒</div>
                </div>
            </div>
            <button id="startButton">ゲームスタート</button>
        </div>
        
        <div id="question">問題が表示されます</div>
        <div id="gameInfo">
            <div id="timer">残り時間: 60秒</div>
            <div id="score">スコア: 0 - 0</div>
        </div>
        <div id="gameArea">
            <div class="player-area player1">
                <div class="player-name">プレイヤー1</div>
                <div class="clouds">
                    <div class="cloud" style="width: 80px; height: 80px; top: 20%; left: 10%; animation-duration: 30s;"></div>
                    <div class="cloud" style="width: 60px; height: 60px; top: 40%; left: 30%; animation-duration: 25s;"></div>
                    <div class="cloud" style="width: 100px; height: 100px; top: 10%; left: 60%; animation-duration: 35s;"></div>
                </div>
            </div>
            <div class="player-area player2">
                <div class="player-name">プレイヤー2</div>
                <div class="clouds">
                    <div class="cloud" style="width: 70px; height: 70px; top: 15%; left: 20%; animation-duration: 28s;"></div>
                    <div class="cloud" style="width: 90px; height: 90px; top: 35%; left: 50%; animation-duration: 32s;"></div>
                    <div class="cloud" style="width: 50px; height: 50px; top: 25%; left: 80%; animation-duration: 22s;"></div>
                </div>
            </div>
        </div>
        <div id="controls">
            プレイヤー1: A, S, D, F, G, H, Q, W キー | プレイヤー2: J, K, L, ;, ', Enter, U, I キー
        </div>
    </div>

    <script>
        // ゲームの状態
        const gameState = {
            timer: 60,
            scores: [0, 0],
            currentQuestion: null,
            correctAnswer: null,
            moles: [],
            timerInterval: null,
            questionTimeout: null,
            // ★ 修正点: モグラが自然に消えるタイマーIDを管理するプロパティを追加
            moleDisappearTimeout: null,
            isGameActive: false,
            molePositions: [
                // プレイヤー1のモグラ穴の位置（8つ）
                [
                    { top: '50px', left: '50px' }, { top: '50px', left: '250px' }, { top: '50px', left: '450px' },
                    { top: '150px', left: '150px' }, { top: '150px', left: '350px' },
                    { top: '250px', left: '50px' }, { top: '250px', left: '250px' }, { top: '250px', left: '450px' }
                ],
                // プレイヤー2のモグラ穴の位置（8つ）
                [
                    { top: '50px', left: '50px' }, { top: '50px', left: '250px' }, { top: '50px', left: '450px' },
                    { top: '150px', left: '150px' }, { top: '150px', left: '350px' },
                    { top: '250px', left: '50px' }, { top: '250px', left: '250px' }, { top: '250px', left: '450px' }
                ]
            ],
            playerKeys: [
                ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyQ', 'KeyW'], // プレイヤー1のキー
                ['KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter', 'KeyU', 'KeyI'] // プレイヤー2のキー
            ],
            settings: {
                operation: 'all',
                difficulty: 'normal',
                time: 60
            },
            questionDuration: 5500,
            moleDisplayTime: 4000,
            nextQuestionDelay: 1500,
            isTransitioning: false
        };

        // ゲーム初期化
        function initGame() {
            setupSettingsPanel();
            document.addEventListener('keydown', handleKeyPress);
            document.getElementById('startButton').addEventListener('click', startGame);
        }

        // 設定パネルの設定
        function setupSettingsPanel() {
            document.querySelectorAll('#operationOptions .setting-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('#operationOptions .setting-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.settings.operation = option.dataset.value;
                });
            });
            
            document.querySelectorAll('#difficultyOptions .setting-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('#difficultyOptions .setting-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.settings.difficulty = option.dataset.value;
                    adjustGamePaceByDifficulty(option.dataset.value);
                });
            });
            
            document.querySelectorAll('#timeOptions .setting-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('#timeOptions .setting-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.settings.time = parseInt(option.dataset.value);
                    gameState.timer = parseInt(option.dataset.value);
                });
            });
        }
        
        function adjustGamePaceByDifficulty(difficulty) {
            switch(difficulty) {
                case 'easy':
                    gameState.moleDisplayTime = 5000;
                    gameState.questionDuration = 6500;
                    break;
                case 'normal':
                    gameState.moleDisplayTime = 4000;
                    gameState.questionDuration = 5500;
                    break;
                case 'hard':
                    gameState.moleDisplayTime = 3000;
                    gameState.questionDuration = 4000;
                    break;
            }
        }

        // モグラ穴を作成
        function createMoleHoles() {
            const playerAreas = document.querySelectorAll('.player-area');
            document.querySelectorAll('.mole-hole').forEach(hole => hole.remove());
            
            for (let p = 0; p < 2; p++) {
                for (let i = 0; i < 8; i++) {
                    const moleHole = document.createElement('div');
                    moleHole.className = 'mole-hole';
                    moleHole.dataset.player = p;
                    moleHole.dataset.index = i;
                    moleHole.style.top = gameState.molePositions[p][i].top;
                    moleHole.style.left = gameState.molePositions[p][i].left;
                    
                    moleHole.addEventListener('click', () => {
                        const mole = moleHole.querySelector('.mole');
                        if (mole && !mole.classList.contains('disabled')) {
                            checkAnswer(p, parseInt(mole.dataset.value));
                        }
                    });
                    
                    playerAreas[p].appendChild(moleHole);
                }
            }
        }

        // ゲーム開始
        function startGame() {
            document.getElementById('settingsPanel').style.display = 'none';
            resetGame();
            createMoleHoles();
            gameState.isGameActive = true;
            
            adjustGamePaceByDifficulty(gameState.settings.difficulty);
            
            generateQuestion();
            
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                updateUI();
                
                if (gameState.timer <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // 同時に6匹のモグラを出現させる（両プレイヤーに同じモグラ）
        function spawnMoles() {
            // ★ 修正点: この関数内でのモグラと配列のクリアはgenerateQuestionに集約
            const values = generateMoleValues();
            
            for (let p = 0; p < 2; p++) {
                const playerArea = document.querySelectorAll('.player-area')[p];
                const moleHoles = Array.from(playerArea.querySelectorAll('.mole-hole'));
                const shuffledHoles = shuffleArray([...moleHoles]).slice(0, 6);
                
                for (let i = 0; i < 6; i++) {
                    const hole = shuffledHoles[i];
                    const value = values[i];
                    
                    const mole = document.createElement('div');
                    mole.className = 'mole';
                    mole.dataset.value = value;
                    
                    // (モグラの見た目を作る要素の追加...変更なし)
                    const eyes = document.createElement('div'); eyes.className = 'eyes';
                    const leftEye = document.createElement('div'); leftEye.className = 'eye';
                    const rightEye = document.createElement('div'); rightEye.className = 'eye';
                    eyes.appendChild(leftEye); eyes.appendChild(rightEye);
                    const nose = document.createElement('div'); nose.className = 'nose';
                    const answer = document.createElement('div'); answer.className = 'answer'; answer.textContent = value;
                    mole.appendChild(eyes); mole.appendChild(nose); mole.appendChild(answer);
                    
                    hole.appendChild(mole);
                    
                    gameState.moles.push({ element: mole, player: p, value: value, hole: hole });
                }
            }
            
            // ★ 修正点: モグラが時間で消えるタイマーをgameStateで管理し、競合を防ぐ
            clearTimeout(gameState.moleDisappearTimeout);
            gameState.moleDisappearTimeout = setTimeout(() => {
                if (!gameState.isTransitioning) {
                    document.querySelectorAll('.mole').forEach(mole => {
                        if (mole.parentNode) mole.remove();
                    });
                    gameState.moles = [];
                }
            }, gameState.moleDisplayTime);
        }

        // モグラの値を生成（正解1つと不正解5つ）
        function generateMoleValues() {
            const values = [gameState.correctAnswer];
            while (values.length < 6) {
                const offset = Math.floor(Math.random() * 10) + 1;
                const value = Math.random() < 0.5 ? gameState.correctAnswer + offset : Math.max(1, gameState.correctAnswer - offset);
                if (!values.includes(value)) values.push(value);
            }
            return shuffleArray(values);
        }

        // 配列をシャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ゲームをリセット
        function resetGame() {
            gameState.timer = gameState.settings.time;
            gameState.scores = [0, 0];
            gameState.isTransitioning = false; // ★ 修正点: 移行状態もリセット
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.questionTimeout);
            clearTimeout(gameState.moleDisappearTimeout); // ★ 修正点: タイマーをクリア
            
            document.querySelectorAll('.mole').forEach(mole => mole.remove());
            document.querySelectorAll('.winner-animation').forEach(animation => animation.remove());
            updateUI();
        }

        // 問題を生成
        function generateQuestion() {
            if (!gameState.isGameActive) return;

            // ★ 修正点: 状態遷移の開始。既存のモグラとタイマーを全てクリアし、状態をクリーンにする
            gameState.isTransitioning = true;
            clearTimeout(gameState.questionTimeout);
            clearTimeout(gameState.moleDisappearTimeout);
            document.querySelectorAll('.mole').forEach(mole => mole.remove());
            gameState.moles = [];

            let operations = (gameState.settings.operation === 'all') ? ['+', '-', '×', '÷'] : [gameState.settings.operation];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let num1, num2, answer;
            const difficulty = gameState.settings.difficulty;
            
            // (問題生成ロジック...変更なし)
            switch (operation) {
                case '+':
                    if (difficulty === 'easy') { num1 = Math.floor(Math.random() * 10) + 1; num2 = Math.floor(Math.random() * 10) + 1; } 
                    else if (difficulty === 'normal') { num1 = Math.floor(Math.random() * 50) + 1; num2 = Math.floor(Math.random() * 50) + 1; } 
                    else { num1 = Math.floor(Math.random() * 100) + 1; num2 = Math.floor(Math.random() * 100) + 1; }
                    answer = num1 + num2;
                    break;
                case '-':
                    if (difficulty === 'easy') { num2 = Math.floor(Math.random() * 10) + 1; num1 = Math.floor(Math.random() * 10) + num2; } 
                    else if (difficulty === 'normal') { num2 = Math.floor(Math.random() * 50) + 1; num1 = Math.floor(Math.random() * 50) + num2; } 
                    else { num2 = Math.floor(Math.random() * 100) + 1; num1 = Math.floor(Math.random() * 100) + num2; }
                    answer = num1 - num2;
                    break;
                case '×':
                    if (difficulty === 'easy') { num1 = Math.floor(Math.random() * 5) + 1; num2 = Math.floor(Math.random() * 5) + 1; } 
                    else if (difficulty === 'normal') { num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; } 
                    else { num1 = Math.floor(Math.random() * 12) + 1; num2 = Math.floor(Math.random() * 12) + 1; }
                    answer = num1 * num2;
                    break;
                case '÷':
                    if (difficulty === 'easy') { num2 = Math.floor(Math.random() * 5) + 1; answer = Math.floor(Math.random() * 5) + 1; } 
                    else if (difficulty === 'normal') { num2 = Math.floor(Math.random() * 10) + 1; answer = Math.floor(Math.random() * 10) + 1; } 
                    else { num2 = Math.floor(Math.random() * 12) + 1; answer = Math.floor(Math.random() * 12) + 1; }
                    num1 = num2 * answer;
                    break;
            }
            
            gameState.currentQuestion = `${num1} ${operation} ${num2} = ?`;
            gameState.correctAnswer = answer;
            document.getElementById('question').textContent = gameState.currentQuestion;

            spawnMoles();
            
            // ★ 修正点: この問題の時間切れで次の問題へ進むタイマーを設定
            gameState.questionTimeout = setTimeout(generateQuestion, gameState.questionDuration);
            
            // ★ 修正点: モグラ出現アニメーション(0.5s)後に操作可能にする
            setTimeout(() => {
                if (gameState.isGameActive) {
                    gameState.isTransitioning = false;
                }
            }, 500);
        }

        // キー入力を処理
        function handleKeyPress(event) {
            if (!gameState.isGameActive || gameState.isTransitioning) return;
            
            for (let p = 0; p < 2; p++) {
                const keyIndex = gameState.playerKeys[p].indexOf(event.code);
                if (keyIndex !== -1) {
                    const moleHoles = document.querySelectorAll(`.player-area`)[p].querySelectorAll('.mole-hole');
                    if (keyIndex < moleHoles.length) {
                        const mole = moleHoles[keyIndex].querySelector('.mole');
                        if (mole && !mole.classList.contains('disabled')) {
                            checkAnswer(p, parseInt(mole.dataset.value));
                        }
                    }
                }
            }
        }

        // 回答をチェック
        function checkAnswer(player, value) {
            if (gameState.isTransitioning) return;
            
            const isCorrect = (value === gameState.correctAnswer);
            const clickedMoleInfo = gameState.moles.find(mole => mole.player === player && mole.value === value && !mole.element.classList.contains('disabled'));

            if (clickedMoleInfo) {
                if (isCorrect) {
                    // ★ 修正点: 正解時の処理を安定化
                    gameState.isTransitioning = true; // 移行状態に入る
                    
                    // ★ 修正点: 全ての自動進行タイマーを停止
                    clearTimeout(gameState.questionTimeout);
                    clearTimeout(gameState.moleDisappearTimeout);

                    gameState.scores[player]++;
                    updateUI();
                    showScoreEffect(clickedMoleInfo.hole, '+1', player);
                    
                    // 全プレイヤーのモグラをヒット状態にし、操作不能にする
                    gameState.moles.forEach(moleInfo => {
                        if (moleInfo.value === gameState.correctAnswer) {
                            moleInfo.element.classList.add('hit');
                        }
                        moleInfo.element.classList.add('disabled');
                    });
                    
                    // ★ 修正点: 遅延後に安全に次の問題へ
                    setTimeout(generateQuestion, gameState.nextQuestionDelay);

                } else {
                    // ★ 修正点: 不正解時はモグラを無効化するだけ
                    clickedMoleInfo.element.classList.add('hit', 'disabled');
                    showScoreEffect(clickedMoleInfo.hole, 'x', player);
                    
                    setTimeout(() => {
                        if (clickedMoleInfo.element.parentNode) {
                            clickedMoleInfo.element.remove();
                        }
                    }, 300);
                }
            }
        }

        // スコアエフェクトを表示
        function showScoreEffect(element, text, player) {
            const effect = document.createElement('div');
            effect.className = 'score-effect';
            effect.textContent = text;
            effect.style.color = player === 0 ? '#66BB6A' : '#FF7043';
            
            const rect = element.getBoundingClientRect();
            const parentRect = element.parentElement.getBoundingClientRect();
            
            effect.style.left = `${rect.left - parentRect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top - parentRect.top}px`;
            
            element.parentElement.appendChild(effect);
            
            setTimeout(() => { effect.remove(); }, 1000);
        }

        // UIを更新
        function updateUI() {
            document.getElementById('timer').textContent = `残り時間: ${gameState.timer}秒`;
            document.getElementById('score').textContent = `スコア: ${gameState.scores[0]} - ${gameState.scores[1]}`;
        }

        // ゲーム終了
        function endGame() {
            gameState.isGameActive = false;
            gameState.isTransitioning = true;
            
            // ★ 修正点: 全てのタイマーを確実に停止する
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.questionTimeout);
            clearTimeout(gameState.moleDisappearTimeout);
            
            let winner = (gameState.scores[0] > gameState.scores[1]) ? 'プレイヤー1の勝ち！'
                       : (gameState.scores[0] < gameState.scores[1]) ? 'プレイヤー2の勝ち！'
                       : '引き分け！';
            let winnerIndex = (gameState.scores[0] > gameState.scores[1]) ? 0 : (gameState.scores[0] < gameState.scores[1]) ? 1 : -1;
            
            document.getElementById('question').textContent = winner;
            
            if (winnerIndex !== -1) {
                showWinnerAnimation(winnerIndex);
            }
            
            setTimeout(() => {
                document.querySelectorAll('.winner-animation').forEach(animation => animation.remove());
                document.getElementById('settingsPanel').style.display = 'flex';
                gameState.isTransitioning = false;
            }, 5000);
        }

        // 勝利演出を表示
        function showWinnerAnimation(winnerIndex) {
            const playerArea = document.querySelectorAll('.player-area')[winnerIndex];
            const animation = document.createElement('div');
            animation.className = 'winner-animation';
            
            const trophy = document.createElement('div');
            trophy.className = 'trophy';
            trophy.textContent = '🏆';
            animation.appendChild(trophy);
            
            const winnerText = document.createElement('div');
            winnerText.className = 'winner-text';
            winnerText.textContent = `プレイヤー${winnerIndex + 1}の勝利！`;
            winnerText.style.color = winnerIndex === 0 ? '#66BB6A' : '#FF7043';
            animation.appendChild(winnerText);
            
            // (紙吹雪と星のエフェクト生成...変更なし)
            const colors = ['#FF5252', '#FFEB3B', '#2196F3', '#4CAF50', '#9C27B0', '#FF9800'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                animation.appendChild(confetti);
            }
            for (let i = 0; i < 10; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = `${Math.random() * 20 + 10}px`;
                star.style.height = `${Math.random() * 20 + 10}px`;
                star.style.top = `${Math.random() * 80 + 10}%`;
                star.style.left = `${Math.random() * 80 + 10}%`;
                star.style.animationDuration = `${Math.random() * 3 + 2}s`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                animation.appendChild(star);
            }
            
            playerArea.appendChild(animation);
        }

        // ゲーム初期化
        window.onload = initGame;
    </script>
</body>
</html>
